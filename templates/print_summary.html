{% extends "base.html" %}

{% block title %}Versión para impresión · Sistema de gestión de tarjetas{% endblock %}

{% block extra_head %}
<style>
  /* Página A4 horizontal (landscape) */
  @page {
    size: A4 landscape;
    margin: 10mm;
  }

  /* Contenedor general de cada página de impresión */
  .print-page {
    margin-bottom: 2rem;
    display: flex;
    flex-direction: column;
    min-height: 100vh;  /* para empujar las firmas al fondo */
  }

  .print-page-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .data-table {
    font-size: 0.8rem;
    border-collapse: collapse;
    width: 100%;
  }

  .data-table thead th,
  .data-table tbody td {
    padding: 0.25rem 0.35rem;
    border-bottom: 1px solid #ddd;
  }

  .data-table thead th {
    border-top: 1px solid #000;
    border-bottom: 2px solid #000;
    background-color: #f5f5f5;
  }

  .data-table tr {
    page-break-inside: avoid;
  }

  /* Zona de firmas al fondo de la página */
  .print-page-body {
    flex: 1 0 auto;  /* contenido ocupa el espacio superior */
  }

  .signature-box {
    margin-top: auto;   /* se pega al fondo de la página */
    padding-top: 1rem;
  }

  .signature-line {
    border-bottom: 1px solid #000;
    width: 70%;
    margin: 0 auto 0.25rem auto;
    height: 2px;
  }

  .signature-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: .03em;
  }

  @media print {
    .no-print {
      display: none !important;
    }

    body {
      background: #ffffff;
      padding-top: 0;
    }

    .content-container {
      box-shadow: none !important;
      margin: 0;
      border-radius: 0;
      padding: 0;
    }

    .print-page {
      page-break-after: always;
    }

    .print-page:last-of-type {
      page-break-after: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="content-container mt-3">

  <!-- Barra superior solo en pantalla -->
  <div class="d-flex justify-content-between align-items-center mb-3 no-print">
    <h2 class="page-title mb-0">Resumen para impresión</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-primary-custom btn-sm" onclick="window.print()">
        <i class="fa-solid fa-print me-1"></i> Imprimir
      </button>
      <a href="{{ url_for('summary') }}" class="btn btn-outline-secondary btn-sm">
        Volver al resumen
      </a>
    </div>
  </div>

  <p class="small text-muted mb-4 no-print">
    Fecha de generación: {{ today }}
  </p>

  {# ========= UNA PÁGINA POR CADA CATEGORÍA ========= #}
  {% for code in categories %}
    {% set detail = details_per_cat[code] %}
    <div class="print-page">
      <div class="print-page-body">
        <h3 class="print-page-title">
          Estado actual de tarjetas · {{ detail.label }}
        </h3>

        <div class="table-responsive">
          <table class="table table-sm align-middle data-table">
            <thead>
              <tr>
                {% for _, label in detail.fields %}
                  <th>{{ label }}</th>
                {% endfor %}
                <th>Activa / Inactiva</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% if detail.rows %}
                {% for r in detail.rows %}
                  <tr>
                    {% for v in r["values"] %}
                      <td>{{ v }}</td>
                    {% endfor %}
                    <td>{{ r.card.status or 'Activa' }}</td>
                    <td>{{ r.estado_texto }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="{{ detail.fields|length + 2 }}"
                      class="text-center text-muted small py-3">
                    No hay tarjetas registradas en esta categoría.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- FIRMAS, PEGADAS ABAJO -->
      <div class="row signature-box">
        <div class="col-6 text-center">
          <div class="signature-line"></div>
          <div class="signature-label">Administradora hotelera</div>
        </div>
        <div class="col-6 text-center">
          <div class="signature-line"></div>
          <div class="signature-label">Supervisor hotelero</div>
        </div>
      </div>
    </div>
  {% endfor %}

  {# ========= ÚLTIMA PÁGINA: RESUMEN GENERAL ========= #}
  <div class="print-page">
    <div class="print-page-body">
      <h3 class="print-page-title">
        Resumen general de tarjetas
      </h3>

      <div class="table-responsive">
        <table class="table table-sm align-middle data-table">
          <thead>
            <tr>
              <th>Categoría</th>
              <th class="text-end">Total</th>
              <th class="text-end">Activas</th>
              <th class="text-end">Inactivas</th>
              <th class="text-end">Pendientes de entrega</th>
            </tr>
          </thead>
          <tbody>
            {% for row in summary_rows %}
              <tr>
                <td>{{ row.category_label }}</td>
                <td class="text-end">{{ row.total }}</td>
                <td class="text-end">{{ row.activas }}</td>
                <td class="text-end">{{ row.inactivas }}</td>
                <td class="text-end">{{ row.pendientes }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted small py-3">
                  No hay datos registrados.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- FIRMAS, PEGADAS ABAJO -->
    <div class="row signature-box">
      <div class="col-6 text-center">
        <div class="signature-line"></div>
        <div class="signature-label">Administradora hotelera</div>
      </div>
      <div class="col-6 text-center">
        <div class="signature-line"></div>
        <div class="signature-label">Supervisor hotelero</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
