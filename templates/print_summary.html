{% extends "base.html" %}

{% block title %}Versión para impresión · Sistema de gestión de tarjetas{% endblock %}

{% block extra_head %}
<style>
  /* Página A4 horizontal */
  @page {
    size: A4 landscape;
    margin: 10mm;
  }

  @media print {
    .content-container {
      box-shadow: none !important;
      margin: 0 !important;
      border-radius: 0 !important;
    }
  }

  .print-page {
    margin-bottom: 2rem;
    page-break-inside: avoid;
  }

  .page-break {
    page-break-after: always;
  }

  .print-page-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .data-table {
    font-size: 0.8rem;
    border-collapse: collapse;
    width: 100%;
  }

  .data-table thead th,
  .data-table tbody td {
    padding: 0.25rem 0.35rem;
    border-bottom: 1px solid #ddd;
  }

  .data-table thead th {
    border-top: 1px solid #000;
    border-bottom: 2px solid #000;
    background-color: #f3f4f6;
    text-align: left;
  }

  .data-table tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }

  /* Última página: firmas al fondo */
  .print-page-summary {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  .summary-table-wrapper {
    flex: 0 0 auto;
  }

  .print-signatures {
    margin-top: auto;
    padding-top: 2rem;
  }

  .signature-block {
    width: 35%;
  }

  .signature-line {
    border-top: 1px solid #000;
    margin-top: 3rem;
    margin-bottom: 0.25rem;
  }

  .signature-name {
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-container mt-3">

  <!-- Título general de la impresión -->
  <div class="text-center mb-4">
    <h2 class="page-title mb-1">Versión para impresión</h2>
    <small class="text-muted">
      Estado actual de las tarjetas registradas por categoría
    </small>
  </div>

  {# 1) DETALLE POR CADA CATEGORÍA: una página por código #}
  {% for code in category_cards.keys() %}
    {% set rows = category_cards[code] %}
    <div class="print-page">
      <h3 class="print-page-title">
        Detalle de tarjetas · Categoría {{ category_labels.get(code, code) }}
      </h3>

      <table class="data-table">
        <thead>
          <tr>
            {% for field_name, label in category_fields[code] %}
              <th>{{ label }}</th>
            {% endfor %}
            <th>Activa / Inactiva</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
              <tr>
                {% for v in r["values"] %}
                  <td>{{ v }}</td>
                {% endfor %}
                <td>{{ r.card.status or 'Activa' }}</td>
                <td>{{ r.estado_texto }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="{{ category_fields[code]|length + 2 }}"
                  class="text-center text-muted">
                No hay tarjetas registradas en esta categoría.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if not loop.last %}
      <div class="page-break"></div>
    {% endif %}
  {% endfor %}

  {# 2) ÚLTIMA PÁGINA: resumen general + firmas #}
  <div class="page-break"></div>

  <div class="print-page print-page-summary">
    <div class="summary-table-wrapper">
      <h3 class="print-page-title">
        Resumen general de tarjetas por categoría
      </h3>

      <table class="data-table">
        <thead>
          <tr>
            <th>Categoría</th>
            <th>Total</th>
            <th>Activas</th>
            <th>Inactivas</th>
            <th>Pendientes de entrega</th>
          </tr>
        </thead>
        <tbody>
          {% for row in summary_rows %}
            <tr>
              <td>{{ row.label }}</td>
              <td>{{ row.total }}</td>
              <td>{{ row.activas }}</td>
              <td>{{ row.inactivas }}</td>
              <td>{{ row.pendientes }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- FIRMAS SOLO EN ESTA ÚLTIMA HOJA -->
    <div class="print-signatures">
      <div class="d-flex justify-content-between">
        <div class="signature-block text-center">
          <div class="signature-line"></div>
          <div class="signature-name">Administradora hotelera</div>
        </div>
        <div class="signature-block text-center">
          <div class="signature-line"></div>
          <div class="signature-name">Supervisor hotelero</div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
